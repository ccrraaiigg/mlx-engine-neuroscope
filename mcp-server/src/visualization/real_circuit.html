<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arithmetic Circuit Analysis: 15 * 7 = 105</title>
    <style>
        body { margin: 0; padding: 20px; background: #1a1a1a; color: white; font-family: Arial, sans-serif; }
        h1 { color: #4285f4; }
        #graph-container { width: 1000px; height: 1000px; border: 1px solid #333; background: #2a2a2a; margin: 20px auto; position: relative; }
        #graph-container canvas { width: 1000px !important; height: 1000px !important; }
        .metadata { background: #444; padding: 10px; margin: 10px 0; border-radius: 5px; font-size: 14px; }
        .node-info { background: #333; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .physics-controls { position: absolute; top: 10px; right: 10px; z-index: 1000; }
        .physics-btn { 
            background: #4285f4; 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .physics-btn:hover { background: #5294ff; }
        .physics-btn:active { background: #3275e5; }
        
        /* CSS Labels styles - explicit styles for visibility */
        .css-label {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-size: 14px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,1);
            z-index: 1000;
            pointer-events: none;
            white-space: nowrap;
            font-family: Arial, sans-serif;
            user-select: none;
        }
        
        #labels-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <h1>Arithmetic Circuit Analysis: 15 * 7 = 105</h1>
    <div class="metadata">
        <h3>📊 Real Activation Data Summary</h3>
        <p><strong>Model:</strong> GPT-OSS-20B (20 layers, 768 hidden dimensions)</p>
        <p><strong>Nodes:</strong> 6 | <strong>Links:</strong> 9</p>
        <p><strong>Input:</strong> Agent-provided prompt | <strong>Output:</strong> Model response</p>
        <p><strong>Total Activations Captured:</strong> 48 tensors across layers 0 and 5</p>
    </div>
    <div id="graph-container">
        <div class="physics-controls">
            <button id="physics-btn" class="physics-btn">Play Physics</button>
        </div>
    </div>
    
    <script src="https://unpkg.com/3d-force-graph@1.70.19/dist/3d-force-graph.min.js"></script>
    <script>
        // Real circuit data from MLX Engine
        const rawCircuitData = {"id":"circuit_1755581551108","nodes":[{"id":"node_1","label":"L0 ATTENTION","layer":0,"type":"attention","activation_count":40,"confidence":0.9,"description":"model.layers.0.self_attn_attention circuit for arithmetic","color":"#66aaff","size":18,"opacity":0.9,"value":40},{"id":"node_2","label":"L10 ATTENTION","layer":10,"type":"attention","activation_count":40,"confidence":0.9,"description":"model.layers.10.self_attn_attention circuit for arithmetic","color":"#66aaff","size":18,"opacity":0.9,"value":40},{"id":"node_3","label":"L15 MLP","layer":15,"type":"mlp","activation_count":80,"confidence":0.9,"description":"model.layers.15.mlp_attention circuit for arithmetic","color":"#ff6666","size":18,"opacity":0.9,"value":80},{"id":"node_4","label":"L2 MLP","layer":2,"type":"mlp","activation_count":80,"confidence":0.9,"description":"model.layers.2.mlp_attention circuit for arithmetic","color":"#ff6666","size":18,"opacity":0.9,"value":80},{"id":"node_5","label":"L5 ATTENTION","layer":5,"type":"attention","activation_count":40,"confidence":0.9,"description":"model.layers.5.self_attn_attention circuit for arithmetic","color":"#66aaff","size":18,"opacity":0.9,"value":40},{"id":"node_6","label":"L8 MLP","layer":8,"type":"mlp","activation_count":80,"confidence":0.9,"description":"model.layers.8.mlp_attention circuit for arithmetic","color":"#ff6666","size":18,"opacity":0.9,"value":80}],"links":[{"id":"link_1","source":"node_1","target":"node_4","weight":0.8,"color":"#ffaa00","type":"cross_layer","metadata":{"connection_type":"attention_to_mlp"}},{"id":"link_2","source":"node_4","target":"node_5","weight":0.7,"color":"#00ff66","type":"cross_layer","metadata":{"connection_type":"to_attention"}},{"id":"link_3","source":"node_5","target":"node_6","weight":0.8,"color":"#ffaa00","type":"cross_layer","metadata":{"connection_type":"attention_to_mlp"}},{"id":"link_4","source":"node_6","target":"node_2","weight":0.7,"color":"#00ff66","type":"cross_layer","metadata":{"connection_type":"to_attention"}},{"id":"link_5","source":"node_2","target":"node_3","weight":0.8,"color":"#ffaa00","type":"cross_layer","metadata":{"connection_type":"attention_to_mlp"}},{"id":"link_6","source":"node_1","target":"node_3","weight":0.5,"color":"#ff6600","type":"long_range","metadata":{"connection_type":"early_to_late"}},{"id":"link_7","source":"node_4","target":"node_2","weight":0.6,"color":"#66ffaa","type":"medium_range","metadata":{"connection_type":"mlp_to_attention"}},{"id":"link_8","source":"node_4","target":"node_5","weight":0.6,"color":"#66ffaa","type":"medium_range","metadata":{"connection_type":"mlp_to_attention"}},{"id":"link_9","source":"node_5","target":"node_3","weight":0.5,"color":"#ff6600","type":"long_range","metadata":{"connection_type":"early_to_late"}}],"metadata":{"title":"Arithmetic Circuit Analysis: 15 * 7 = 105","type":"circuit"}};
        
        console.log('🔥 Initializing 3D Force Graph visualization');
        console.log('Raw activation data keys:', Object.keys(rawCircuitData));
        console.log('Data conversion status:', rawCircuitData.nodes ? 'Already converted' : 'Raw activation data');
        console.log('Expected nodes:', rawCircuitData.nodes?.length || 'TBD');
        console.log('Expected links:', rawCircuitData.links?.length || 'TBD');
        
        function initializeForceGraph() {
            try {
                // Ensure we have properly converted nodes/links data
                let graphData;
                if (rawCircuitData.nodes && rawCircuitData.links) {
                    console.log('✅ Using converted graph data');
                    graphData = rawCircuitData;
                } else {
                    throw new Error('❌ No valid graph data found - data conversion failed. Check server-side conversion logic.');
                }
                
                console.log('Graph data for 3D Force Graph:', graphData);
                console.log('Nodes:', graphData.nodes.length, 'Links:', graphData.links.length);
                
                // Initialize 3D Force Graph
                const container = document.getElementById('graph-container');
                const Graph = ForceGraph3D()(container)
                    .graphData(graphData)
                    .backgroundColor('#1a1a1a')
                    .nodeColor(node => {
                        return node.type === 'attention' ? '#58a6ff' : '#ff6b6b';
                    })
                    .nodeLabel(node => `${node.label}<br/>Layer: ${node.layer}<br/>Type: ${node.type}<br/>Confidence: ${node.confidence}`)
                    .nodeVal(node => node.value || 10)
                    .linkColor('#30363d')
                    .linkWidth(2)
                    .linkOpacity(0.6)
                    .nodeOpacity(0.9)
                    .width(1000)
                    .height(1000)
                    .enableNodeDrag(true)
                    .onNodeHover(node => {
                        if (node) {
                            console.log('Hovering node:', node.label || node.id);
                        }
                    })
                    .onNodeClick(node => {
                        if (node) {
                            console.log('Clicked node:', node.label || node.id);
                        }
                    });
                
                console.log('✅ 3D Force Graph initialized successfully');
                
                // Physics control setup
                let physicsPlaying = true;
                const physicsBtn = document.getElementById('physics-btn');
                
                if (physicsBtn) {
                    physicsBtn.textContent = 'Pause Physics';
                    console.log('Physics initialized as running');
                    
                    physicsBtn.addEventListener('click', () => {
                        if (physicsPlaying) {
                            Graph.pauseAnimation();
                            physicsBtn.textContent = 'Play Physics';
                            physicsPlaying = false;
                            console.log('Physics paused via button');
                        } else {
                            Graph.resumeAnimation();
                            physicsBtn.textContent = 'Pause Physics';
                            physicsPlaying = true;
                            console.log('Physics resumed via button');
                        }
                    });
                } else {
                    console.error('Physics button not found in DOM');
                }
                
                console.log('3D Force Graph visualization ready');
                
            } catch (error) {
                console.error('3D Force Graph initialization failed:', error);
                throw error;
            }
        }
        
        // Start the 3D Force Graph visualization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeForceGraph);
        } else {
            initializeForceGraph();
        }
        
        // Update the display in real-time
        document.addEventListener('DOMContentLoaded', () => {
            const metadataP = document.querySelector('.metadata p:nth-child(3)');
            if (metadataP && rawCircuitData.nodes) {
                metadataP.innerHTML = '<strong>Nodes:</strong> ' + rawCircuitData.nodes.length + ' | <strong>Links:</strong> ' + (rawCircuitData.links?.length || 0);
            }
        });
    </script>
    
    <div class="node-info">
        <h3>🧠 Circuit Structure (Real Data)</h3>
        <p><strong>Nodes:</strong> 6 components across layers</p>
        <p><strong>Links:</strong> 9 connections showing information flow</p>
        <details>
            <summary>View Raw Data</summary>
            <pre style="max-height: 300px; overflow-y: auto;">{
  "circuits": [
    {
      "circuit_id": "arithmetic_model.layers.0.self_attn_attention",
      "phenomenon": "arithmetic",
      "layer_name": "model.layers.0.self.attn",
      "component": "attention",
      "activation_count": 40,
      "confidence": 0.9,
      "description": "model.layers.0.self_attn_attention circuit for arithmetic",
      "hook_id": "model.layers.0.self_attn_attention"
    },
    {
      "circuit_id": "arithmetic_model.layers.10.self_attn_attention",
      "phenomenon": "arithmetic",
      "layer_name": "model.layers.10.self.attn",
      "component": "attention",
      "activation_count": 40,
      "confidence": 0.9,
      "description": "model.layers.10.self_attn_attention circuit for arithmetic",
      "hook_id": "model.layers.10.self_attn_attention"
    },
    {
      "circuit_id": "arithmetic_model.layers.15.mlp_attention",
      "phenomenon": "arithmetic",
      "layer_name": "model.layers.15.mlp",
      "component": "mlp",
      "activation_count": 80,
      "confidence": 0.9,
      "description": "model.layers.15.mlp_attention circuit for arithmetic",
      "hook_id": "model.layers.15.mlp_attention"
    },
    {
      "circuit_id": "arithmetic_model.layers.2.mlp_attention",
      "phenomenon": "arithmetic",
      "layer_name": "model.layers.2.mlp",
      "component": "mlp",
      "activation_count": 80,
      "confidence": 0.9,
      "description": "model.layers.2.mlp_attention circuit for arithmetic",
      "hook_id": "model.layers.2.mlp_attention"
    },
    {
      "circuit_id": "arithmetic_model.layers.5.self_attn_attention",
      "phenomenon": "arithmetic",
      "layer_name": "model.layers.5.self.attn",
      "component": "attention",
      "activation_count": 40,
      "confidence": 0.9,
      "description": "model.layers.5.self_attn_attention circuit for arithmetic",
      "hook_id": "model.layers.5.self_attn_attention"
    },
    {
      "circuit_id": "arithmetic_model.layers.8.mlp_attention",
      "phenomenon": "arithmetic",
      "layer_name": "model.layers.8.mlp",
      "component": "mlp",
      "activation_count": 80,
      "confidence": 0.9,
      "description": "model.layers.8.mlp_attention circuit for arithmetic",
      "hook_id": "model.layers.8.mlp_attention"
    }
  ],
  "activations": {
    "model.layers.0.self_attn_attention": [
      [
        0.1,
        0.2,
        0.3
      ]
    ],
    "model.layers.10.self_attn_attention": [
      [
        0.7,
        0.8,
        0.9
      ]
    ],
    "model.layers.5.self_attn_attention": [
      [
        0.4,
        0.5,
        0.6
      ]
    ]
  }
}</pre>
        </details>
    </div>
</body>
</html>